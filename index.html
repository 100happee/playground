<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, set, onValue, push, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// --- Firebase config (your provided config) ---
const firebaseConfig = {
  apiKey: "AIzaSyBKrYvB_DSoFI155CJqTQZzzEsy6zoUFGM",
  authDomain: "playground-61be7.firebaseapp.com",
  databaseURL: "https://playground-61be7-default-rtdb.firebaseio.com",
  projectId: "playground-61be7",
  storageBucket: "playground-61be7.firebasestorage.app",
  messagingSenderId: "906388783261",
  appId: "1:906388783261:web:21fd0bfc2b9dade6359474"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// wait until game ready
await new Promise(r => { if (window.gameReady) return r(); const t=setInterval(()=>{if(window.gameReady){clearInterval(t);r();}},50); });

// === DOM and settings ===
const nameInput=document.getElementById('nameInput');
const colorInput=document.getElementById('colorInput');
const applyBtn=document.getElementById('applyBtn');
const resetBtn=document.getElementById('resetBtn');
const messagesEl=document.getElementById('messages');
const msgInput=document.getElementById('msgInput');
const sendBtn=document.getElementById('sendBtn');
const menuToggle=document.getElementById('menuToggle');
const settingsPanel=document.getElementById('settingsPanel');
const closeMenu=document.getElementById('closeMenu');

menuToggle.addEventListener('click',()=>{settingsPanel.style.display='block';menuToggle.style.display='none';});
closeMenu.addEventListener('click',()=>{settingsPanel.style.display='none';menuToggle.style.display='block';});

let clientId=localStorage.getItem('clientId'); if(!clientId){clientId='p_'+Math.random().toString(36).slice(2,9);localStorage.setItem('clientId',clientId);}
nameInput.value=localStorage.getItem('playerName')||('Player_'+clientId.slice(-4));
colorInput.value=localStorage.getItem('playerColor')||'#00ffaa';

// === Helpers ===
function makeCubeMaterial(hex){
  const base=new THREE.Color(hex);
  const darker=base.clone().multiplyScalar(0.82);
  const lighter=base.clone().multiplyScalar(1.18);
  return [
    new THREE.MeshStandardMaterial({color:darker}),
    new THREE.MeshStandardMaterial({color:darker}),
    new THREE.MeshStandardMaterial({color:lighter}),
    new THREE.MeshStandardMaterial({color:base}),
    new THREE.MeshStandardMaterial({color:base}),
    new THREE.MeshStandardMaterial({color:base})
  ];
}

function applySettings(){
  localStorage.setItem('playerName',nameInput.value||('Player_'+clientId.slice(-4)));
  localStorage.setItem('playerColor',colorInput.value);
  window.player.material=makeCubeMaterial(colorInput.value);
  writePlayer();
}
applyBtn.addEventListener('click',applySettings);
resetBtn.addEventListener('click',()=>{localStorage.removeItem('playerName');localStorage.removeItem('playerColor');nameInput.value='Player_'+clientId.slice(-4);colorInput.value='#00ffaa';applySettings();});

sendBtn.addEventListener('click',sendChat);
msgInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendChat();});
function sendChat(){
  const txt=msgInput.value.trim();if(!txt)return;
  const msgRef=push(ref(db,'messages'));
  set(msgRef,{name:nameInput.value||('Player_'+clientId.slice(-4)),text:txt,timestamp:Date.now(),clientId,color:colorInput.value});
  msgInput.value='';
}

// === Player sync ===
function writePlayer(){
  const p={x:window.player.position.x,y:window.player.position.y,z:window.player.position.z,name:nameInput.value||('Player_'+clientId.slice(-4)),color:colorInput.value,ts:Date.now()};
  set(ref(db,'players/'+clientId),p);
}
window.addEventListener('beforeunload',()=>remove(ref(db,'players/'+clientId)));

// === Other players ===
const others={};

// create/update others from DB
onValue(ref(db,'players'),snap=>{
  const data=snap.val()||{};
  for(const id in data){
    if(id===clientId)continue;
    const d=data[id];
    if(!others[id]){
      const cube=new THREE.Mesh(window.playerGeo,makeCubeMaterial(d.color||'#ffaa00'));
      cube.position.set(d.x||0,d.y||0,d.z||0);
      window.scene.add(cube);

      const nameEl=document.createElement('div');nameEl.className='nametag';nameEl.textContent=d.name||'Anon';document.getElementById('app').appendChild(nameEl);
      const speech=document.createElement('div');speech.className='speech';speech.style.display='none';
      const bubble=document.createElement('div');bubble.className='bubble';speech.appendChild(bubble);
      document.getElementById('app').appendChild(speech);

      others[id]={cube,nameEl,speech,targetPos:cube.position.clone(),lastMsg:0};
    }else{
      const o=others[id];
      o.targetPos.set(d.x||0,d.y||0,d.z||0);
      o.nameEl.textContent=d.name||o.nameEl.textContent;
      o.cube.material=makeCubeMaterial(d.color||'#ffaa00');
    }
  }
  // remove players not present
  for(const id in others){if(!(id in data)){const o=others[id];window.scene.remove(o.cube);o.nameEl.remove();o.speech.remove();delete others[id];}}
});

// === Chat + speech bubbles ===
onChildAdded(ref(db,'messages'),snap=>{
  const m=snap.val();if(!m)return;
  const time=new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  const d=document.createElement('div');
  d.style.padding='6px 8px';d.style.marginBottom='6px';d.style.borderRadius='6px';d.style.background='rgba(255,255,255,0.02)';
  d.innerHTML=`<strong style="color:${m.color||'#fff'}">${escapeHtml(m.name)}</strong> <span style="opacity:0.8">[${time}]</span>: ${escapeHtml(m.text)}`;
  messagesEl.appendChild(d);messagesEl.scrollTop=messagesEl.scrollHeight;

  if(m.clientId===clientId){
    const wrap=document.createElement('div');wrap.className='speech';
    const b=document.createElement('div');b.className='bubble';b.textContent=m.text;wrap.appendChild(b);
    document.getElementById('app').appendChild(wrap);
    setTimeout(()=>wrap.remove(),4000);
  }else if(others[m.clientId]){
    const o=others[m.clientId];
    const bubble=o.speech.querySelector('.bubble');
    bubble.textContent=m.text;
    o.speech.style.display='block';
    o.lastMsg=Date.now();
    setTimeout(()=>{if(Date.now()-o.lastMsg>=3500)o.speech.style.display='none';},4000);
  }
});

function escapeHtml(t){return String(t).replace(/[&<"']/g,m=>({'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#039;'}[m]));}

// === Interpolation and nametag updates ===
(function loop(){
  requestAnimationFrame(loop);
  // interpolate cube movement
  for(const id in others){
    const o=others[id];
    o.cube.position.lerp(o.targetPos,0.1);
    const screen=toScreenPosition(o.cube.position.clone().add(new THREE.Vector3(0,1.25,0)),window.camera,window.renderer);
    o.nameEl.style.left=(screen.x-o.nameEl.offsetWidth/2)+'px';
    o.nameEl.style.top=(screen.y-28)+'px';
    o.speech.style.left=(screen.x-(o.speech.offsetWidth||60)/2)+'px';
    o.speech.style.top=(screen.y-48)+'px';
  }
})();
function toScreenPosition(pos,camera,renderer){
  const widthHalf=0.5*renderer.domElement.clientWidth;
  const heightHalf=0.5*renderer.domElement.clientHeight;
  pos.project(camera);
  return{x:(pos.x*widthHalf)+widthHalf,y:-(pos.y*heightHalf)+heightHalf};
}

// write position often
setInterval(()=>writePlayer(),120);
</script>
